import boto3
import pandas as pd
import csv

s3 = boto3.resource("s3")
bucket = s3.Bucket("korea-s3")

objects_to_delete = []
obejcts_of_interest = []
imei_set = {'866758044058713',
 '866758044059398',
 '866758044059943',
 '866758044059976',
 '866758044060222',
 '866758044060305',
 '866758044062012',
 '866758044062491',
 '866758044064208',
 '866758044065932',
 '866758044066047',
 '866758044066864',
 '866758044067797',
 '866758044068522',
 '866758044070528',
 '866758044070973',
 '866758044071120',
 '866758044071211',
 '866758044072342',
 '866758044072557',
 '866758044072805',
 '866758044073910',
 '866758044075949',
 '866758044076863',
 '866758044077309',
 '866758044077952',
 '866758044078331',
 '866758044078687',
 '866758044080006',
 '866758044080055',
 '866758044080618',
 '866758044080659',
 '866758044080790',
 '866758044080865',
 '866758044080881',
 '866758044080899',
 '866758044082028',
 '866758044082655',
 '866758044083422',
 '866758044084370',
 '866758044084586',
 '866758044084867',
 '866758044085302',
 '866758044085567',
 '866758044086409',
 '866758044091540',
 '866758044092076',
 '866758044092811',
 '866758044092894',
 '866758044092944',
 '866758044093710',
 '866758044093892',
 '866758044094445',
 '866758044094825',
 '866758044094858',
 '866758044095335',
 '866758044096671',
 '866758044096879',
 '866758044098065',
 '866758044098289',
 '866758044099055',
 '866758044099139',
 '866758044099162',
 '866758044099436',
 '866758044099535',
 '866758044099642',
 '866758044100135',
 '866758044100986',
 '866758044101752',
 '866758044102073',
 '866758044102107',
 '866758044102602',
 '866758044102651',
 '866758044102909',
 '866758044103261',
 '866758044103386',
 '866758044103626',
 '866758044103790',
 '866758044104236',
 '866758044104418',
 '866758044104731',
 '866758044105597',
 '866758044105829',
 '866758044106439',
 '866758044106694',
 '866758044109243',
 '866758044109441',
 '866758044109573',
 '866758044109656',
 '866758044112460',
 '866758044112528',
 '866758044112676',
 '866758044112940',
 '866758044113179',
 '866758044113229',
 '866758044113435',
 '866758044113484',
 '866758044113708',
 '866758044113872',
 '866758044114631',
 '866758044115125',
 '866758044115265',
 '866758044115646',
 '866758044115711',
 '866758044115968',
 '866758044116081',
 '866758044116222',
 '866758044116644',
 '866758044116784',
 '866758044116966',
 '866758044117162',
 '866758044117972'}


for obj in boto3.resource("s3").Bucket("korea-s3").objects.all() :
    if (obj.key.split("/")[-1].split(".")[-1] == "mp4") and (int(obj.last_modified.strftime("%Y%m%d")[:6]) < 202009) and (obj.key.split("/")[0] not in imei_set):
        
        objects_to_delete.append({"Key" : obj.key})
        obejcts_of_interest.append(obj)


with open("./obejcet_to_delete.csv", 'w', newline='\n', encoding="utf-8") as file :
    writer = csv.writer(file)
    writer.writerow(obejcts_of_interest)

begin = 0
end = begin + 1000
while end < len(objects_to_delete) :
    bucket.delete_objects(
        Delete = {
            "Objects" : objects_to_delete[begin:end]
        }
    )
    print(begin, end)
    begin += 1000
    end = begin + 1000
    
bucket.delete_objects(
    Delete = {
        "Objects" : objects_to_delete[begin:len(objects_to_delete)-1]
    }
)
print(begin, len(objects_to_delete)-1)



dum = 0
for ob in obejcts_of_interest :
    dum += ob.size
print(f"{dum/1000000000 : 4.2f} GB is reduced")
